<!DOCTYPE html>
<html>

  <head>
    <title>Atlas Reality</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Lato:300,400" rel="stylesheet">
    <link href="https://afeld.github.io/emoji-css/emoji.css" rel="stylesheet">
    <!-- <link rel="stylesheet" type="text/css" href="https://www.atlasreality.xyz/style.css" /> -->
    <link rel="stylesheet" type="text/css" href='style.css' />

    <!-- defines the firebase library -->
    <script src="https://www.gstatic.com/firebasejs/3.7.4/firebase.js"></script>
    <script>
        var config = {
            apiKey: "AIzaSyBI9kkVq2jZNpTKjaX79BqgcepavI9wzQs",
            authDomain: "mosaic-portal.firebaseapp.com",
            projectId: "mosaic-portal",
            storageBucket: "mosaic-portal.appspot.com",
            databaseURL: "https://mosaic-portal.firebaseio.com"
        };
        // cF2SedCeMFWTmEP4evpFcogOONH3 <-- cianna@mariecanning.com uid
        firebase.initializeApp(config);
    </script>
  </head>
  <body>

    <div class="dashnavbar">
      <ul class="ulnavbar">
        <li><a href="https://www.atlasreality.xyz" class="generalnav">Atlas</a></li>
        <li><a class="generalnav">SDK</a></li>
        <li><a class="dashnavelement">{{username}}</a></li>
        <li><a href="https://www.atlasreality.xyz/auth/logout" class="dashnavelement">Logout</a></li>

        <li class="addbuttonnav" title="Add Scene">
          <label for="file-upload" class="custom-file-upload">
              <img src="https://www.atlasreality.xyz/addButton3.png" alt="Add new scene" height="32" width="32">
              <input id="file-upload" type="file" name="scene" value="Please upload your scene">
              <script>
                // https://eloquentjavascript.net/18_forms.html
                var fileUploadButton = document.querySelector('input');
                fileUploadButton.addEventListener("change", function() {

                  var userID = "{{uid}}";

                  var storage = firebase.storage();
                  var database = firebase.database();

                  console.log('1. init');

                  if (fileUploadButton.files.length > 0) {
                    var file = fileUploadButton.files[0];
                    var storageRef = storage.ref().child(`users/${userID}/${file.name}`);
                    var databaseRef = database.ref(`users/${userID}/scenes/`);

                    console.log('2. references created');
                    // TODO: IMPORTANT Check that BOTH the database reference AND the storage have completed - only create db ref after storage
                    databaseRef.push().set({
                      aid: file.name
                    }).then(function() {
                      console.log('3. data pushed');
                      var uploadTask = storageRef.put(file);
                      console.log('4. upload task');
                      uploadTask.on(firebase.storage.TaskEvent.STATE_CHANGED, // or 'state_changed'
                         function() {
                           console.log('5. reloading page');
                           location.reload(true); // when `true` is set it will reload from the server
                      });
                    });
                  } // end if
                });
              </script>
          </label>
        </li>

      </ul>
    </div>

    <div>

      <h3>Your Scenes:</h3>

      <ul>
				{{#each scenes}}
        <li>
           {{this.aid}}
        </li>
        {{/each}}
      </ul>
    </div>

    <!-- <div class="wrapper"> -->
      <!-- <div class="grid-item"> -->
        <!-- <div>
            <label for="file-upload" class="custom-file-upload">
                <img src="https://www.atlasreality.xyz/addButton.png" alt="Add new scene" height="162" width="162">
                <input id="file-upload" type="file" name="scene" value="Please upload your scene">
                <script>
                  // https://eloquentjavascript.net/18_forms.html
                  var fileUploadButton = document.querySelector('input');
                  fileUploadButton.addEventListener("change", function() {

                    var userID = "{{uid}}";

                    var storage = firebase.storage();
                    var database = firebase.database();

                    console.log('1. init');

                    if (fileUploadButton.files.length > 0) {
                      var file = fileUploadButton.files[0];
                      var storageRef = storage.ref().child(`users/${userID}/${file.name}`);
                      var databaseRef = database.ref(`users/${userID}/scenes/`);

                      console.log('2. references created');

                      databaseRef.push().set({
                        aid: file.name
                      }).then(function() {
                        console.log('3. data pushed');
                        var uploadTask = storageRef.put(file);
                        console.log('4. upload task');
                        uploadTask.on(firebase.storage.TaskEvent.STATE_CHANGED, // or 'state_changed'
                           function() {
                             console.log('5. reloading page');
                             location.reload(true); // when `true` is set it will reload from the server
                        });
                      });
                    } // end if
                  });
                </script>
            </label>
        </div> -->
        <!-- <p>Add New Scene</p> -->
      <!-- </div> -->


      <!-- <p>{{scenes}}</p> -->

      <!-- Add all the scenes in a loop below -->

      <!-- <div class="grid-item"><img src="" alt="" height="162" width="91"><p>Scene</p></div> -->
      <!-- <div class="grid-item"><img src="" alt="" height="162" width="91"><p>Scene</p></div> -->
      <!-- <div class="grid-item"><img src="" alt="" height="162" width="91"><p>Scene</p></div> -->
      <!-- <div class="grid-item"><img src="" alt="" height="162" width="91"><p>Scene</p></div> -->
      <!-- <div class="grid-item"><img src="" alt="" height="162" width="91"><p>Scene</p></div> -->
      <!-- <div class="grid-item"><img src="" alt="" height="162" width="91"><p>Scene</p></div> -->
    <!-- </div> -->

  </body>
</html>
